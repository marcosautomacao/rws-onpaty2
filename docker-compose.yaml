version: '3'

services:
  visualizador:
    image: dockersamples/visualizer
    volumes:
    - "/var/run/docker.sock:/var/run/docker.sock"
    ports:
    - 8079:8080
    deploy:
      placement:
        constraints:
          - node.role == manager
  front-end:
    image: nginx
    container_name: front-end
    ports:
      - '8084:80'
    volumes: 
      - "${PWD}/front-microservicos/:/usr/share/nginx/html"
      - "${PWD}/front-microservicos/nginx.conf/:/etc/nginx/conf.d/default.conf"
    deploy:
      restart_policy:
        condition: on-failure
        delay: 5s
    networks:
      - net

  rws-onparty-middleware:
      container_name: rws-onparty-middleware
      image: maven:3.3-jdk-8
      ports:
        - '8081:8081'
      volumes: 
        - "${PWD}/rws-onparty-middleware:/usr/src/app"
        - "${HOME}/.m2:/root/.m2"
      working_dir: /usr/src/app
      deploy:
        restart_policy:
            condition: on-failure
            delay: 5s
      networks:
        - net
      entrypoint: ["mvn", "clean", "install", "spring-boot:run"]

  rws-onparty-customer:
      container_name: rws-onparty-customer
      image: maven:3.3-jdk-8
      ports:
        - '8083:8083'
      volumes: 
        - "${PWD}/rws-onparty-customer:/usr/src/app"
        - "${HOME}/.m2:/root/.m2"
      working_dir: /usr/src/app
      deploy:
        restart_policy:
            condition: on-failure
            delay: 5s
      networks:
        - net
      entrypoint: ["mvn", "clean", "install", "spring-boot:run"]
  rws-onparty-supplier:
      container_name: rws-onparty-supplier
      image: maven:3.3-jdk-8
      ports:
        - '8082:8082'
      volumes: 
        - "${PWD}/rws-onparty-supplier:/usr/src/app"
        - "${HOME}/.m2:/root/.m2"
      working_dir: /usr/src/app
      deploy:
        restart_policy:
            condition: on-failure
            delay: 5s
      networks:
        - net
      entrypoint: ["mvn", "clean", "install", "spring-boot:run"]
  db-suppliers:
    image: postgres
    ports:
      - "5432:5432"
    environment:
      - POSTGRES_PASSWORD=123
      - POSTGRES_USER=postgres
      - POSTGRES_DB=onparty-suppliers
    networks:
      - net
  db-customers:
    image: postgres
    ports:
      - "5452:5432"
    environment:
      - POSTGRES_PASSWORD=123
      - POSTGRES_USER=postgres
      - POSTGRES_DB=onparty-customers
    networks:
      - net

networks:
  net:
    external: true
